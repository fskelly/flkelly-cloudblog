

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 3 - </title>

  <meta name="description" content="Author(s): Robin Heringa and Fletcher Kelly
Implementing LDAPS identity integration with Azure VMware Solution series - 3 of 4
This is the third part of the blog series on how to implement LDAPS identity integration with Azure VMware Solution. Other parts of this series can be found here:

LDAPS integration - part 1 of 4
LDAPS integration - part 2 of 4
LDAPS integration - part 4 of 4

Implement LDAPS integration
The following sections will guide you through the required process step-by-step">
  <meta name="author" content="Fletcher Kelly"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Fletcher\u0027s Cloud Blog",
    
    "url": "http:\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "http:\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "http:\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "http:\/\/localhost:1313\/post\/2023\/avs-ldaps-configure-part3\/",
          "name": "Azure vmware solution a comprehensive guide to ldaps identity integration part 3"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Fletcher Kelly"
  },
  "headline": "Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 3",
  "description" : "Author(s): Robin Heringa and Fletcher Kelly\nImplementing LDAPS identity integration with Azure VMware Solution series - 3 of 4 This is the third part of the blog series on how to implement LDAPS identity integration with Azure VMware Solution. Other parts of this series can be found here:\nLDAPS integration - part 1 of 4 LDAPS integration - part 2 of 4 LDAPS integration - part 4 of 4 Implement LDAPS integration The following sections will guide you through the required process step-by-step\n",
  "inLanguage" : "en",
  "wordCount":  2085 ,
  "datePublished" : "2023-01-25T08:45:43\u002b00:00",
  "dateModified" : "2023-01-25T08:45:43\u002b00:00",
  "image" : "http:\/\/localhost:1313\/",
  "keywords" : [ "AVS, Identity, LDAPS" ],
  "mainEntityOfPage" : "http:\/\/localhost:1313\/post\/2023\/avs-ldaps-configure-part3\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "http:\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "http:\/\/localhost:1313\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 3" />
<meta property="og:description" content="Author(s): Robin Heringa and Fletcher Kelly
Implementing LDAPS identity integration with Azure VMware Solution series - 3 of 4
This is the third part of the blog series on how to implement LDAPS identity integration with Azure VMware Solution. Other parts of this series can be found here:

LDAPS integration - part 1 of 4
LDAPS integration - part 2 of 4
LDAPS integration - part 4 of 4

Implement LDAPS integration
The following sections will guide you through the required process step-by-step">
<meta property="og:url" content="http://localhost:1313/post/2023/avs-ldaps-configure-part3/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Fletcher&#39;s Cloud Blog" />

  <meta name="twitter:title" content="Azure VMware Solution: A comprehensive guide to LDAPS identity ‚Ä¶" />
  <meta name="twitter:description" content="Author(s): Robin Heringa and Fletcher Kelly
Implementing LDAPS identity integration with Azure VMware Solution series - 3 of 4
This is the third part of the blog series on how to implement LDAPS ‚Ä¶">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="generator" content="Hugo 0.139.2">
  <link rel="alternate" href="http://localhost:1313/index.xml" type="application/rss+xml" title="Fletcher&#39;s Cloud Blog"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="http://localhost:1313/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://localhost:1313/css/highlight.min.css" /><link rel="stylesheet" href="http://localhost:1313/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://localhost:1313/">Fletcher&#39;s Cloud Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About Blog" href="/page/about/">About Blog</a>
            </li>
          
        
          
            <li>
              <a title="About Fletcher Kelly" href="/page/fletcherkelly/">About Fletcher Kelly</a>
            </li>
          
        
          
            <li>
              <a title="About Robin Heringa" href="/page/robinheringa/">About Robin Heringa</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 3</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 25, 2023
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;10&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2085&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Fletcher Kelly
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Author(s): <a href="/page/robinheringa/">Robin Heringa</a> and <a href="/page/fletcherkelly/">Fletcher Kelly</a></p>
<h1 id="implementing-ldaps-identity-integration-with-azure-vmware-solution-series---3-of-4">Implementing LDAPS identity integration with Azure VMware Solution series - 3 of 4</h1>
<p>This is the third part of the blog series on how to implement LDAPS identity integration with Azure VMware Solution. Other parts of this series can be found here:</p>
<ol>
<li><a href="../avs-ldaps-configure-part1/">LDAPS integration - part 1 of 4</a></li>
<li><a href="../avs-ldaps-configure-part2/">LDAPS integration - part 2 of 4</a></li>
<li><a href="../avs-ldaps-configure-part4/">LDAPS integration - part 4 of 4</a></li>
</ol>
<h1 id="implement-ldaps-integration">Implement LDAPS integration</h1>
<p>The following sections will guide you through the required process step-by-step</p>
<h2 id="check-domain-controller-certificates-and-ldaps">Check domain controller certificates and LDAPS</h2>
<p>It is important to validate that the identity provider (in most cases Active Directory) is configured to support LDAPS based authentication requests before continuing with the LDAPS integration setup.</p>
<p>For each domain controller that is designated for use with Azure VMware Solution, check if the required certificate(s) with the &ldquo;server authentication&rdquo; intended purpose are present in the computer certificate store. The &ldquo;Certificates&rdquo; snap-in for the Microsoft Management Console (mmc.exe) offers a simple way to do this.</p>
<p>After locally or remotely opening the computer certificate store:</p>
<ol>
<li>Expand the &ldquo;Personal&rdquo; certificate store and click &ldquo;Certificates&rdquo;;</li>
<li>Check if the store contains certificates with the &ldquo;Server Authentication&rdquo; intended purpose.</li>
</ol>
<p>Available certificates for <strong>avs-gwc-dc001.avsemea.com</strong>:

<link rel="stylesheet" href="http://localhost:1313/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/1-avs-gwc-dc001-certificates.jpg" alt="avs-gwc-dc001-certificates mmc"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/1-avs-gwc-dc001-certificates.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</p>
<p>Available certificates for <strong>avs-gwc-dc002.avsemea.com</strong>:


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/2-avs-gwc-dc002-certificates.jpg" alt="avs-gwc-dc002-certificates mmc"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/2-avs-gwc-dc002-certificates.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</p>
<p>Next we need to verify whether the Active Directory domain controllers are configured to offer LDAPS services:</p>
<ol>
<li>Open a &ldquo;Command prompt&rdquo; windows;</li>
<li>Run the command &ldquo;Netstat -a&rdquo;;</li>
<li>Verify that there is an active listener for TCP port 636.</li>
</ol>
<p>LDAPS listener for <strong>avs-gwc-dc001.avsemea.com</strong>:


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/3-avs-gwc-dc001-netstat.jpg" alt="avs-gwc-dc001-netstat-results"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/3-avs-gwc-dc001-netstat.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</p>
<p>LDAPS listener for <strong>avs-gwc-dc002.avsemea.com</strong>:


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/4-avs-gwc-dc002-netstat.jpg" alt="avs-gwc-dc002-netstat-results"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/4-avs-gwc-dc002-netstat.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</p>
<h2 id="extract-correct-domain-controller-certificates">Extract (correct) domain controller certificates</h2>
<p>As a next step the certificates used by the domain controllers for LDAPS services need to be extracted from the domain controllers. This step is always performed by executing the script shown in the image below. The reason for this is to ensure we extract the correct certificate which is &ldquo;attached&rdquo; to the LDAPS service. When multiple certificates are available with the &ldquo;Server Authentication&rdquo; intended purpose, the domain controller selects one of them to be used for LDAPS.</p>
<p>With the following commands we will connect to the required domain controllers. In our scenario, these are <strong>avs-gwc-dc001.avsemea.com</strong> and <strong>avs-gwc-dc002.avsemea.com</strong> and we then use OpenSSL to extract the required certificates. You will need to specify the path of your openssl.exe, currently tested version is 3.0 and was installed with <a href="https://community.chocolatey.org/packages/openssl">Chocolatey</a>. Our install path is <strong>C:\Program Files\OpenSSL-Win64\bin\openssl.exe</strong>. You will need to update the export path to suit your needs, we chose to use <strong>c:\certTemp</strong></p>
<p><strong>Notes</strong><br>
<em><strong>$openSSLFilePath</strong></em> may need to be changed, was installed using <a href="https://community.chocolatey.org/packages/openssl">chocolatey</a> in our example.<br>
<em><strong>$remoteComputers</strong></em> would need to be changed to suit your environment.<br>
<em><strong>$exportFolder</strong></em> can be changed to something more suitable for your environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## Get certs</span>
</span></span><span class="line"><span class="cl"><span class="nv">$openSSLFilePath</span> <span class="p">=</span> <span class="s2">&#34;C:\Program Files\OpenSSL-Win64\bin\openssl.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$remoteComputers</span> <span class="p">=</span> <span class="s2">&#34;avs-gwc-dc001.avsemea.com&#34;</span><span class="p">,</span><span class="s2">&#34;avs-gwc-dc002.avsemea.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$port</span> <span class="p">=</span> <span class="s2">&#34;636&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$exportFolder</span> <span class="p">=</span> <span class="s2">&#34;c:\temp\&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$computer</span> <span class="k">in</span> <span class="nv">$remoteComputers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$output</span> <span class="p">=</span>  <span class="nb">echo </span><span class="s2">&#34;1&#34;</span> <span class="p">|</span> <span class="p">&amp;</span> <span class="nv">$openSSLFilePath</span> <span class="s2">&#34;s_client&#34;</span> <span class="s2">&#34;-connect&#34;</span> <span class="s2">&#34;</span><span class="nv">$computer</span><span class="s2">`:</span><span class="nv">$port</span><span class="s2">&#34;</span> <span class="s2">&#34;-showcerts&#34;</span> <span class="p">|</span> <span class="nb">out-string</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Matches</span> <span class="p">=</span> <span class="vm">$null</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cn</span> <span class="p">=</span> <span class="nv">$output</span> <span class="o">-match</span> <span class="s2">&#34;0 s\:CN = (?&lt;cn&gt;.*?)\r\n&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cn</span> <span class="p">=</span> <span class="nv">$Matches</span><span class="p">.</span><span class="py">cn</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Matches</span> <span class="p">=</span> <span class="vm">$null</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$certs</span> <span class="p">=</span> <span class="nb">select-string</span> <span class="n">-inputobject</span> <span class="nv">$output</span> <span class="n">-pattern</span> <span class="s2">&#34;(?s)(?&lt;cert&gt;-----BEGIN CERTIFICATE-----.*?-----END CERTIFICATE-----)&#34;</span> <span class="n">-allmatches</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cert</span> <span class="p">=</span> <span class="nv">$certs</span><span class="p">.</span><span class="n">matches</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$exportPath</span> <span class="p">=</span> <span class="nv">$exportFolder</span><span class="p">+(</span><span class="nv">$computer</span><span class="p">.</span><span class="py">split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)[</span><span class="mf">0</span><span class="p">])+</span><span class="s2">&#34;.cer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cert</span><span class="p">.</span><span class="py">Value</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="nv">$exportPath</span> <span class="n">-Encoding</span> <span class="n">ascii</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/5-powershell-cert-extract.jpg" alt="PowerShell-using-openssl-to-extract-certs"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/5-powershell-cert-extract.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="validate-domain-controller-certificate-requirements">Validate domain controller certificate requirements</h2>
<p>The next step is to ensure that the certificate extraction was performed successfully. This will always be a manual step in the process.</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/6-certificate-properties.jpg" alt="Exported-certificate-properties"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/6-certificate-properties.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>As displayed in the image above:</p>
<ol>
<li>Open Windows Explorer (or use the one opened in the previous step if not closed already üòä) and browse to the location where the certificates were extracted to. In our scenario the folder is c:\certTemp;</li>
<li>Open the certificates by right-clicking and selecting &ldquo;Open&rdquo;</li>
</ol>
<p>For each of the certificates:</p>
<ol start="3">
<li>Select the &ldquo;General&rdquo; tab at the top;</li>
<li>Verify that &ldquo;Proves your identity to a remote computer&rdquo; is available as an intended purpose;</li>
<li>Verify that domain controller fully qualified domain name FQDN) is present in the &ldquo;Issued to&rdquo; field. In our scenario: <strong>avs-gwc-dc001.avsemea.com</strong> and <strong>avs-gwc-dc002.avsemea.com</strong>.</li>
<li>Verify that the certificate is still valid by checking the &ldquo;Valid from&rdquo; field.</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/7-certificate-certification-path.jpg" alt="Certification-path-of-the-certificate"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/7-certificate-certification-path.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>To complete the certificate verification process, for each certificate:</p>
<ol>
<li>Click the &ldquo;Certification Path&rdquo; tab at the top;</li>
<li>Verify that the full certificate authority chain is available in the &ldquo;Certification path&rdquo; field.
In our scenario the field contains the name of the root certification authority <strong>avsemea-avs-gwc-rootca</strong> and the full certificate name for the respective domain controller the certificate is issued to. In our scenario <strong>avs-gwc-dc001.avsemea.com</strong> and <strong>avs-gwc-dc002.avsemea.com</strong>.</li>
</ol>
<h2 id="create-azure-storage-account">Create Azure Storage account</h2>
<p>The following content is divided into two sub-sections. One section will describe how the required procedure is performed manually through the Azure Portal and the other section describes a way to perform the required steps through automation.</p>
<h3 id="manual-deployment">Manual deployment</h3>
<p>As part of this manual process a storage account will be created that is used to store the domain controller certificates for later use by the &ldquo;New-LDAPSIdentitySource&rdquo; run-command.</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/8-manual-storage-account-create.jpg" alt="create-storage-account-from-portal"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/8-manual-storage-account-create.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>In the Azure Portal:</p>
<ol>
<li>Click on &ldquo;Storage accounts&rdquo; in the left navigation panel;</li>
<li>Click &ldquo;+ Create&rdquo; at the top to create a new storage account. The &ldquo;Create a storage account&rdquo; blade will now be displayed.</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/9-manual-storage-account-create-2.jpg" alt="create-storage-account-from-portal-storage-account-information"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/9-manual-storage-account-create-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>On the &ldquo;basics&rdquo; tab:</p>
<ol>
<li>In the &ldquo;Subscription&rdquo; drop-down menu make sure you select the subscription where Azure VMware Solution has been deployed into. In our scenario this is the <strong>Azure CXP FTA Internal ‚Äì AZFTA subscription</strong>;</li>
<li>Select the resource group you want to create the storage account into. In our case <strong>avs-germanywestcentral-operational_rg</strong>.</li>
<li>In the &ldquo;Storage account name&rdquo; box, enter a globally unique name for the storage account. We recommend to use a descriptive name postfixed with a GUID. In our scenario we used <strong>avsgwcsa14a2c2db</strong>;</li>
<li>In the &ldquo;Region&rdquo; drop-down menu be sure to select the same region as where Azure VMware Solution is deployed. In our scenario <strong>Germany West Central</strong>.</li>
<li>As this storage account has no need for changing any of the default settings, click &ldquo;Review&rdquo; at the bottom of the screen.</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/10-manual-storage-account-review.jpg" alt="create-storage-account-from-portal-storage-account-review"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/10-manual-storage-account-review.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>On the review screen:</p>
<ol>
<li>Double-check the values for &ldquo;Subscription&rdquo;, &ldquo;Resource Group&rdquo;, &ldquo;Location&rdquo; and &ldquo;Storage account name&rdquo;;</li>
<li>Click &ldquo;Create&rdquo;.
After a few minutes the creation of the storage account should be completed:</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/11-manual-storage-account-review-2.jpg" alt="create-storage-account-from-portal-storage-account-review-complete"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/11-manual-storage-account-review-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h3 id="automated-deployment">Automated deployment</h3>
<p>With these commands, we will check for the Azure Module, install them if missing and then continue the script. We will create the required storage account, or use an existing storage account. The <strong>$storageAccountName</strong>  and <strong>$resourceGroupLocation</strong> variables can be updated or replaced as needed to meet your needs. These scripts are designed to be run in sections one after each other to ensure the variable names are correctly referenced.</p>
<p><strong>Notes</strong><br>
<em><strong>$resourceGroupLocation</strong></em> will need to be updated to your desired location.<br>
<em><strong>$storageRgName</strong></em> will need to be updated.<br>
<em><strong>$storageAccountName</strong></em> will need to be updated.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## Do you have the Azure Module installed?</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nb">Get-Module</span> <span class="n">-ListAvailable</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="n">Storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="nb">write-output</span> <span class="s2">&#34;Module exists&#34;</span> <span class="p">}</span>        
</span></span><span class="line"><span class="cl"><span class="k">else</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;Module does not exist&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;installing Module&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Install-Module</span> <span class="n">-name</span> <span class="n">Az</span><span class="p">.</span><span class="py">Storage</span> <span class="n">-Scope</span> <span class="n">CurrentUser</span> <span class="n">-Force</span> <span class="n">-AllowClobber</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## create storage account</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$resourceGroupLocation</span> <span class="p">=</span> <span class="s2">&#34;germanywestcentral&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageRgName</span> <span class="p">=</span> <span class="s2">&#34;avs-</span><span class="nv">$resourceGroupLocation</span><span class="s2">-operational_rg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c">## Storage account variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$guid</span> <span class="p">=</span> <span class="nb">New-Guid</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountName</span> <span class="p">=</span> <span class="s2">&#34;avsgwcsa&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountNameSuffix</span> <span class="p">=</span> <span class="nv">$guid</span><span class="p">.</span><span class="py">ToString</span><span class="p">().</span><span class="py">Split</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountName</span> <span class="p">=</span> <span class="p">((</span><span class="nv">$storageAccountName</span><span class="p">.</span><span class="py">replace</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))+</span><span class="nv">$storageAccountNameSuffix</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c">## Define tags to be used if needed</span>
</span></span><span class="line"><span class="cl"><span class="c">## tags can be modified to suit your needs, another example below.</span>
</span></span><span class="line"><span class="cl"><span class="c">#$tags = @{&#34;Environment&#34;=&#34;Development&#34;;&#34;Owner&#34;=&#34;FTA&#34;;&#34;CostCenter&#34;=&#34;123456&#34;}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$tags</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span><span class="s2">&#34;deploymentMethod&#34;</span><span class="p">=</span><span class="s2">&#34;PowerShell&#34;</span><span class="p">;</span> <span class="s2">&#34;Technology&#34;</span><span class="p">=</span><span class="s2">&#34;AVS&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c">## create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nv">$saCheck</span> <span class="p">=</span> <span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="vm">$null</span> <span class="o">-eq</span> <span class="nv">$saCheck</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-Location</span> <span class="nv">$resourceGroupLocation</span> <span class="n">-SkuName</span> <span class="n">Standard_LRS</span> <span class="n">-Kind</span> <span class="n">StorageV2</span> <span class="n">-EnableHttpsTrafficOnly</span> <span class="vm">$true</span> <span class="n">-Tags</span> <span class="nv">$tags</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Storage account created: </span><span class="nv">$storageAccountName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;Storage Account already exists&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/12-automated-create-storage-account.jpg" alt="scripted-creation-of-storage-account"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/12-automated-create-storage-account.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="create-storage-blob-container">Create Storage Blob container</h2>
<p>The next step is to create a blob container to help structure/organize the resources required for the LDAPS identity integration.
The following content is divided into two sub-sections. One section will describe how the required procedure is performed manually through the Azure Portal and the other section describes a way to perform the required steps through automation.</p>
<h3 id="manual-deployment-1">Manual deployment</h3>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/13-manual-create-container.jpg" alt="create-storage-container"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/13-manual-create-container.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>In the Azure Portal:</p>
<ol>
<li>In the left navigation pane, click &ldquo;Storage accounts&rdquo;;</li>
<li>In the list of storage accounts, select the storage account created in the previous step. In our scenario <strong>avsgwcsa14a2c2db</strong>;</li>
<li>Select &ldquo;Containers&rdquo; under the &ldquo;Data storage&rdquo; category;</li>
<li>Click &ldquo;+ Container&rdquo; to create a new container in the storage account.</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/14-manual-create-container-2.jpg" alt="create-storage-container-final"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/14-manual-create-container-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>In the &ldquo;New container&rdquo; dialog:</p>
<ol>
<li>In the &ldquo;Name&rdquo; field, type a descriptive name for the new container. In our scenario <strong>ldaps-blog-post</strong>.</li>
<li>Click &ldquo;Create&rdquo;
The new container should now be created and displayed in the &ldquo;Containers&rdquo; view for the storage account:</li>
</ol>
<h3 id="automated-deployment-1">Automated deployment</h3>
<p>With these commands, we will create the container to upload the earlier exported certificates to, this will be important for the creation of the SAS Tokens for the AVS LDAPS Run Command.</p>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create container</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerName</span> <span class="p">=</span> <span class="s2">&#34;ldaps-blog-post&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerCheck</span> <span class="p">=</span> <span class="nb">Get-AzStorageContainer</span> <span class="n">-name</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span><span class="p">).</span><span class="py">Context</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="vm">$null</span> <span class="o">-eq</span> <span class="nv">$containerCheck</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-AzStorageContainer</span> <span class="n">-name</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span><span class="p">).</span><span class="py">Context</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Storage container created: </span><span class="nv">$containerName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;Container already exists&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/15-automated-create-storage-container.jpg" alt="create-storage-container"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/15-automated-create-storage-container.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="upload-domain-controller-certificates">Upload domain controller certificates</h2>
<p>The next step is to upload the domain controller certificates from the temporary folder where they were extracted to into the newly created <strong>ldaps-blog-post</strong> container in the <strong>avsgwcsa14a2c2db</strong> storage account we created.
The following content is also divided into two sub-sections. One section will describe how the required procedure is performed manually through the Azure Portal and the other section describes a way to perform the required steps through automation.</p>
<h3 id="manual-deployment-2">Manual deployment</h3>
<p>As the first step, it is needed to &ldquo;enter&rdquo; the <strong>ldaps-blog-post</strong> container in the storage account:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/16-manual-upload-certs-1.jpg" alt="start-of-cert-upload-process"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/16-manual-upload-certs-1.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<ol>
<li>In the Azure Portal, navigate to the <strong>avsgwcsa14a2c2db</strong> storage account created earlier and select &ldquo;Containers&rdquo;;</li>
<li>Click the <strong>ldaps-blog-post</strong> container.</li>
</ol>
<p>We will now upload the certificates into the container:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/17-manual-upload-certs-2.jpg" alt="start-of-cert-upload-process-1"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/17-manual-upload-certs-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<ol>
<li>In the <strong>ldaps-blog-post</strong> container, select &ldquo;Overview&rdquo;;</li>
<li>In the top navigation, click &ldquo;‚¨ÜÔ∏è Upload&rdquo;;</li>
<li>In the &ldquo;Upload blob&rdquo; panel, click the folder icon to select the certificates from your local hard drive.</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/18-manual-upload-certs-3.jpg" alt="start-of-cert-upload-process-3"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/18-manual-upload-certs-3.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Navigate to the folder where the certificates have been extracted to (in our scenario c:\certTemp) and:</p>
<ol>
<li>Select all the certificates;</li>
<li>Click &ldquo;Open&rdquo;.</li>
</ol>
<p>The &ldquo;Open&rdquo; screen will close and return to the Azure Portal &ldquo;Upload blob&rdquo; panel again, click &ldquo;Upload&rdquo; at the bottom of the screen:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/19-manual-upload-certs-4.jpg" alt="upload-certs-4"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/19-manual-upload-certs-4.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>The certificates will now be uploaded into the blob container. The process is complete when green checkmarks are shown for each certificate uploaded:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/20-manual-upload-certs-complete.jpg" alt="upload-certs-complete"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/20-manual-upload-certs-complete.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h3 id="automated-deployment-2">Automated deployment</h3>
<p>With these commands, we will upload the actual certificates into the previously created container. In this example we are using &ldquo;<strong>ldaps-blog-post</strong>&rdquo;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## upload certs to container</span>
</span></span><span class="line"><span class="cl"><span class="nv">$certs</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$exportFolder</span> <span class="n">-Filter</span> <span class="p">*.</span><span class="n">cer</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageContext</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span><span class="p">).</span><span class="py">Context</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="nv">$certs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$localFilePath</span> <span class="p">=</span> <span class="nv">$item</span><span class="p">.</span><span class="py">FullName</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$azureFileName</span> <span class="p">=</span> <span class="nv">$localFilePath</span><span class="p">.</span><span class="py">Split</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">)[</span><span class="nv">$localFilePath</span><span class="p">.</span><span class="py">Split</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">).</span><span class="n">count</span><span class="p">-</span><span class="mf">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Get-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="p">|</span> <span class="nb">Get-AzStorageContainer</span> <span class="n">-Name</span> <span class="nv">$containerName</span> <span class="p">|</span> <span class="nb">Set-AzStorageBlobContent</span> <span class="o">-File</span> <span class="nv">$localFilePath</span> <span class="n">-Blob</span> <span class="nv">$azureFileName</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/21-automated-upload-certs-1.jpg" alt="scripted-cert-upload-1"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/21-automated-upload-certs-1.jpg" itemprop="contentUrl"></a>
  </figure>
</div>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/22-automated-upload-certs-2.jpg" alt="scripted-cert-upload-2"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/22-automated-upload-certs-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="generate-sas-tokens-for-domain-controller-certificates">Generate SAS tokens for domain controller certificates</h2>
<p>As part of this step we will generate &ldquo;shared access tokens&rdquo; for all the certificates uploaded into the blob container so they can be accessed through the run-command for implementing the LDAPS integration for vCenter.
One section describes how the required procedure is performed manually through the Azure Portal and the other section describes a way to perform the required steps through automation.</p>
<h3 id="manual-deployment-3">Manual deployment</h3>
<p>The manual deployment continues within the same blade in the Azure Portal where the previous step left off.
For each of the uploaded certificates, generate a &ldquo;<strong>SAS token</strong>&rdquo;:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/23-manual-generate-sas-1.jpg" alt="sas-process-1"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/23-manual-generate-sas-1.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>For each certificate separately:</p>
<ol>
<li>Select the checkbox in front of the container;</li>
<li>Click the ellipsis at the end of the line;</li>
<li>Select &ldquo;Generate SAS&rdquo;.</li>
</ol>
<p>In the following screen:</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/24-manual-generate-sas-2.jpg" alt="sas-process-2"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/24-manual-generate-sas-2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<ol>
<li>Make sure to select a proper validity period for the SAS token. By default the SAS token will be valid for 8 hours which should be sufficient when performing the configuration in a continuous effort;</li>
<li>Click &ldquo;Generate SAS token and URL&rdquo;.
After clicking &ldquo;Generate SAS token and URL&rdquo; an additional section will be displayed at the bottom of the screen:</li>
</ol>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/25-manual-generate-sas-complete.jpg" alt="sas-process-complete"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/25-manual-generate-sas-complete.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Be sure to copy the &ldquo;Blob SAS URL&rdquo; generated for each separate certificate into a text-file temporarily as they will need to be concatenated into a single string <strong>separated by a comma</strong> for use during the execution of the run-command as explained in step &ldquo;Execute Run-Command&rdquo;.</p>
<h3 id="automated-deployment-3">Automated deployment</h3>
<p>With these commands, we will generate the SAS Token needed for the next steps, please note down <strong>BOTH</strong> tokens. In this script, the tokens are valid for <strong>24 hours</strong> and can be modified to suit your needs.</p>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create SAS token</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerName</span> <span class="p">=</span> <span class="s2">&#34;ldaps-blog-post&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$blobs</span> <span class="p">=</span> <span class="nb">Get-AzStorageBlob</span> <span class="n">-Container</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="nv">$storageContext</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="py">name</span> <span class="o">-match</span> <span class="s2">&#34;.cer&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$blob</span> <span class="k">in</span> <span class="nv">$blobs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$StartTime</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$EndTime</span> <span class="p">=</span> <span class="nv">$startTime</span><span class="p">.</span><span class="py">AddHours</span><span class="p">(</span><span class="mf">24.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sasToken</span> <span class="p">=</span> <span class="nb">New-AzStorageBlobSASToken</span> <span class="n">-Container</span> <span class="nv">$containerName</span> <span class="n">-Blob</span> <span class="nv">$blob</span><span class="p">.</span><span class="py">name</span> <span class="n">-Permission</span> <span class="n">rwd</span> <span class="n">-StartTime</span> <span class="nv">$StartTime</span> <span class="n">-ExpiryTime</span> <span class="nv">$EndTime</span> <span class="n">-Context</span> <span class="nv">$storageContext</span> <span class="n">-FullUri</span>
</span></span><span class="line"><span class="cl">    <span class="c">#$sasToken</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-host</span> <span class="s2">&#34;SASToken created: </span><span class="nv">$sasToken</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure-part3/26-automated-sas-token-creation.jpg" alt="scripted=sas-token-creation"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure-part3/26-automated-sas-token-creation.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p><a href="https://github.com/fskelly/flkelly-cloudblog/blob/main/content/post/2023/avs-ldaps-configure-part1/snippets.ps1">snippets.ps1 file (all code commands)</a><br>
<a href="../avs-ldaps-configure-part2/">&lt; Previous</a> <a href="../avs-ldaps-configure-part4/">Next&gt;</a></p>


        
          <div class="blog-tags">
            
              
              <a href="http://localhost:1313/tags/avs/">AVS</a>&nbsp;
            
              
              <a href="http://localhost:1313/tags/identity/">Identity</a>&nbsp;
            
              
              <a href="http://localhost:1313/tags/ldaps/">LDAPS</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f&amp;text=Azure%20VMware%20Solution%3a%20A%20comprehensive%20guide%20to%20LDAPS%20identity%20integration%20-%20Part%203&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f&amp;title=Azure%20VMware%20Solution%3a%20A%20comprehensive%20guide%20to%20LDAPS%20identity%20integration%20-%20Part%203" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f&amp;title=Azure%20VMware%20Solution%3a%20A%20comprehensive%20guide%20to%20LDAPS%20identity%20integration%20-%20Part%203" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f&amp;title=Azure%20VMware%20Solution%3a%20A%20comprehensive%20guide%20to%20LDAPS%20identity%20integration%20-%20Part%203" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure-part3%2f&amp;description=Azure%20VMware%20Solution%3a%20A%20comprehensive%20guide%20to%20LDAPS%20identity%20integration%20-%20Part%203" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/2023/avs-new-ldaps-run-command/">New LDAPS run-command for Azure VMware Solution</a></li>
                
                    <li><a href="/post/2023/avs-ldaps-configure-part1/">Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 1</a></li>
                
                    <li><a href="/post/2023/avs-ldaps-configure-part2/">Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 2</a></li>
                
                    <li><a href="/post/2023/avs-ldaps-configure-part4/">Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 4</a></li>
                
                    <li><a href="/post/2022/poc-vwan-avs/">Using Azure Virtual WAN to connect to Azure VMware Solution</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="http://localhost:1313/post/2023/avs-ldaps-configure-part4/" data-toggle="tooltip" data-placement="top" title="Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 4">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="http://localhost:1313/post/2023/avs-ldaps-configure-part2/" data-toggle="tooltip" data-placement="top" title="Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 2">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/fskelly" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/fletcherkelly" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Fletcher Kelly
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="http://localhost:1313/">Fletcher&#39;s Cloud Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.139.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="http://localhost:1313/js/main.js"></script>
<script src="http://localhost:1313/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="http://localhost:1313/js/load-photoswipe.js"></script>










    
  </body>
</html>


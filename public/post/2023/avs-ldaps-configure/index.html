

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>How to configure LDAPS with AVS - </title>

  <meta name="description" content="In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).
Pre-requisites

Jump Box
RSAT Tools
PowerShell installed

The expected outcome

Variables we used and information you need
1. Log into Azure
2. Export required certificates
3. Create a storage account
4. Create a container
5. Upload certificates to container
6. Create the SAS Tokens
Execute the AVS Run Command

The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well.">
  <meta name="author" content="Fletcher Kelly"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Fletcher\u0027s Cloud Blog",
    
    "url": "http:\/\/localhost:1313\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "http:\/\/localhost:1313\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "http:\/\/localhost:1313\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "http:\/\/localhost:1313\/post\/2023\/avs-ldaps-configure\/",
          "name": "How to configure ldaps with avs"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Fletcher Kelly"
  },
  "headline": "How to configure LDAPS with AVS",
  "description" : "In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).\nPre-requisites\nJump Box RSAT Tools PowerShell installed The expected outcome\nVariables we used and information you need 1. Log into Azure 2. Export required certificates 3. Create a storage account 4. Create a container 5. Upload certificates to container 6. Create the SAS Tokens Execute the AVS Run Command The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well.\n",
  "inLanguage" : "en",
  "wordCount":  858 ,
  "datePublished" : "2023-01-09T08:39:32\u002b00:00",
  "dateModified" : "2023-01-09T08:39:32\u002b00:00",
  "image" : "http:\/\/localhost:1313\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "http:\/\/localhost:1313\/post\/2023\/avs-ldaps-configure\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "http:\/\/localhost:1313\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "http:\/\/localhost:1313\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="How to configure LDAPS with AVS" />
<meta property="og:description" content="In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).
Pre-requisites

Jump Box
RSAT Tools
PowerShell installed

The expected outcome

Variables we used and information you need
1. Log into Azure
2. Export required certificates
3. Create a storage account
4. Create a container
5. Upload certificates to container
6. Create the SAS Tokens
Execute the AVS Run Command

The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well.">
<meta property="og:url" content="http://localhost:1313/post/2023/avs-ldaps-configure/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Fletcher&#39;s Cloud Blog" />

  <meta name="twitter:title" content="How to configure LDAPS with AVS" />
  <meta name="twitter:description" content="In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).
Pre-requisites

Jump Box
RSAT Tools
PowerShell installed

The expected outcome

Variables we used …">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="generator" content="Hugo 0.139.2">
  <link rel="alternate" href="http://localhost:1313/index.xml" type="application/rss+xml" title="Fletcher&#39;s Cloud Blog"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="http://localhost:1313/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="http://localhost:1313/css/highlight.min.css" /><link rel="stylesheet" href="http://localhost:1313/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://localhost:1313/">Fletcher&#39;s Cloud Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About Blog" href="/page/about/">About Blog</a>
            </li>
          
        
          
            <li>
              <a title="About Fletcher Kelly" href="/page/fletcherkelly/">About Fletcher Kelly</a>
            </li>
          
        
          
            <li>
              <a title="About Robin Heringa" href="/page/robinheringa/">About Robin Heringa</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>How to configure LDAPS with AVS</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 9, 2023
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;5&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;858&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Fletcher Kelly
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>In this post, we are going to be configuring LDAPS (LDAP Over SSL) for Azure Vmware Solution (AVS).</p>
<p>Pre-requisites</p>
<ol>
<li>Jump Box</li>
<li>RSAT Tools</li>
<li>PowerShell installed</li>
</ol>
<p>The expected outcome</p>
<ul>
<li><a href="#variables-we-used-and-information-you-need">Variables we used and information you need</a></li>
<li><a href="#1-log-into-azure">1. Log into Azure</a></li>
<li><a href="#2-export-required-certificates">2. Export required certificates</a></li>
<li><a href="#3-create-a-storage-account">3. Create a storage account</a></li>
<li><a href="#4-create-a-container">4. Create a container</a></li>
<li><a href="#5-upload-certificates-to-container">5. Upload certificates to container</a></li>
<li><a href="#6-create-the-sas-tokens">6. Create the SAS Tokens</a></li>
<li><a href="#execute-the-avs-run-command">Execute the AVS Run Command</a></li>
</ul>
<p>The plan is to automate as much of this process as possible. We will use PowerShell to complete steps 1-6 as above. For now, step 7 needs to be manual, we are working on automating this as well.</p>
<h2 id="variables-we-used-and-information-you-need">Variables we used and information you need</h2>
<p>We use the following.<br>
DNS Name = avsemea.com<br>
Netbios Name = AVSEMEA<br>
You will see that we use the Fully Qualified domain names later with the computer names we reference later. We use FQDN as much as possible and try to hard code as little making these snippets more portable into your environment(s).</p>
<p>We are using a jump-box, which is domain joined, deployed into Azure and protected with <a href="https://learn.microsoft.com/en-us/azure/bastion/bastion-overview">Azure Bastion</a>. THe snippets below are run on this jump-box, which has <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools">RSAT</a> installed.</p>
<h2 id="1-log-into-azure">1. Log into Azure</h2>
<p>Update the variables as needed, in this case, <em><strong>$azSubscriptionID</strong></em></p>
<p><strong>Notes</strong><br>
<em><strong>$azSubscriptionID</strong></em> would need to be updated with your Subscription ID.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$azSubscriptionID</span> <span class="p">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">Login-AzAccount</span>
</span></span><span class="line"><span class="cl"><span class="nb">Set-AzContext</span> <span class="n">-Subscription</span> <span class="nv">$azSubscriptionID</span>
</span></span></code></pre></div><h2 id="2-export-required-certificates">2. Export required certificates</h2>
<p>You will need to have OpenSSL installed. You can do this manually, or use a package manager like <a href="https://winget.run/pkg/ShiningLight/OpenSSL">winget</a> or
<a href="https://community.chocolatey.org/packages/openssl">chocolatey</a></p>
<p><strong>Notes</strong><br>
<em><strong>$openSSLFilePath</strong></em> may need to be changed, was installed using <a href="https://community.chocolatey.org/packages/openssl">chocolatey</a> in our example.<br>
<em><strong>$remoteComputers</strong></em> would need to be changed to suit your environment.<br>
<em><strong>$exportFolder</strong></em> can be changed to something more suitable for your environment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## Get certs</span>
</span></span><span class="line"><span class="cl"><span class="nv">$openSSLFilePath</span> <span class="p">=</span> <span class="s2">&#34;C:\Program Files\OpenSSL-Win64\bin\openssl.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$remoteComputers</span> <span class="p">=</span> <span class="s2">&#34;avs-gwc-dc001.avsemea.com&#34;</span><span class="p">,</span><span class="s2">&#34;avs-gwc-dc002.avsemea.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$port</span> <span class="p">=</span> <span class="s2">&#34;636&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$exportFolder</span> <span class="p">=</span> <span class="s2">&#34;c:\temp\&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$computer</span> <span class="k">in</span> <span class="nv">$remoteComputers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$output</span> <span class="p">=</span>  <span class="nb">echo </span><span class="s2">&#34;1&#34;</span> <span class="p">|</span> <span class="p">&amp;</span> <span class="nv">$openSSLFilePath</span> <span class="s2">&#34;s_client&#34;</span> <span class="s2">&#34;-connect&#34;</span> <span class="s2">&#34;</span><span class="nv">$computer</span><span class="s2">`:</span><span class="nv">$port</span><span class="s2">&#34;</span> <span class="s2">&#34;-showcerts&#34;</span> <span class="p">|</span> <span class="nb">out-string</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Matches</span> <span class="p">=</span> <span class="vm">$null</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cn</span> <span class="p">=</span> <span class="nv">$output</span> <span class="o">-match</span> <span class="s2">&#34;0 s\:CN = (?&lt;cn&gt;.*?)\r\n&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cn</span> <span class="p">=</span> <span class="nv">$Matches</span><span class="p">.</span><span class="py">cn</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$Matches</span> <span class="p">=</span> <span class="vm">$null</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$certs</span> <span class="p">=</span> <span class="nb">select-string</span> <span class="n">-inputobject</span> <span class="nv">$output</span> <span class="n">-pattern</span> <span class="s2">&#34;(?s)(?&lt;cert&gt;-----BEGIN CERTIFICATE-----.*?-----END CERTIFICATE-----)&#34;</span> <span class="n">-allmatches</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cert</span> <span class="p">=</span> <span class="nv">$certs</span><span class="p">.</span><span class="n">matches</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$exportPath</span> <span class="p">=</span> <span class="nv">$exportFolder</span><span class="p">+(</span><span class="nv">$computer</span><span class="p">.</span><span class="py">split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)[</span><span class="mf">0</span><span class="p">])+</span><span class="s2">&#34;.cer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$cert</span><span class="p">.</span><span class="py">Value</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="nv">$exportPath</span> <span class="n">-Encoding</span> <span class="n">ascii</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>You can see the exported files in the picture below.</p>

<link rel="stylesheet" href="http://localhost:1313/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet1.jpg" alt="code-snippet-1"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet1.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="3-create-a-storage-account">3. Create a storage account</h2>
<p><strong>Notes</strong><br>
<em><strong>$resourceGroupLocation</strong></em> will need to be updated to your desired location.<br>
<em><strong>$storageRgName</strong></em> will need to be updated.<br>
<em><strong>$storageAccountName</strong></em> will need to be updated.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create storage account</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$resourceGroupLocation</span> <span class="p">=</span> <span class="s2">&#34;germanywestcentral&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageRgName</span> <span class="p">=</span> <span class="s2">&#34;avs-</span><span class="nv">$resourceGroupLocation</span><span class="s2">-operational_rg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c">## Storage account variables</span>
</span></span><span class="line"><span class="cl"><span class="nv">$guid</span> <span class="p">=</span> <span class="nb">New-Guid</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountName</span> <span class="p">=</span> <span class="s2">&#34;avsgwcsa&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountNameSuffix</span> <span class="p">=</span> <span class="nv">$guid</span><span class="p">.</span><span class="py">ToString</span><span class="p">().</span><span class="py">Split</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageAccountName</span> <span class="p">=</span> <span class="p">((</span><span class="nv">$storageAccountName</span><span class="p">.</span><span class="py">replace</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))+</span><span class="nv">$storageAccountNameSuffix</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c">## Define tags to be used if needed</span>
</span></span><span class="line"><span class="cl"><span class="c">## tags can be modified to suit your needs, another example below.</span>
</span></span><span class="line"><span class="cl"><span class="c">#$tags = @{&#34;Environment&#34;=&#34;Development&#34;;&#34;Owner&#34;=&#34;FTA&#34;;&#34;CostCenter&#34;=&#34;123456&#34;}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$tags</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span><span class="s2">&#34;deploymentMethod&#34;</span><span class="p">=</span><span class="s2">&#34;PowerShell&#34;</span><span class="p">;</span> <span class="s2">&#34;Technology&#34;</span><span class="p">=</span><span class="s2">&#34;AVS&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c">## create storage account</span>
</span></span><span class="line"><span class="cl"><span class="nv">$saCheck</span> <span class="p">=</span> <span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="vm">$null</span> <span class="o">-eq</span> <span class="nv">$saCheck</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-Location</span> <span class="nv">$resourceGroupLocation</span> <span class="n">-SkuName</span> <span class="n">Standard_LRS</span> <span class="n">-Kind</span> <span class="n">StorageV2</span> <span class="n">-EnableHttpsTrafficOnly</span> <span class="vm">$true</span> <span class="n">-Tags</span> <span class="nv">$tags</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Storage account created: </span><span class="nv">$storageAccountName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;Storage Account already exists&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet2.jpg" alt="code-snippet-2"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet2.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="4-create-a-container">4. Create a container</h2>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create container</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerName</span> <span class="p">=</span> <span class="s2">&#34;ldaps&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerCheck</span> <span class="p">=</span> <span class="nb">Get-AzStorageContainer</span> <span class="n">-name</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span><span class="p">).</span><span class="py">Context</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="vm">$null</span> <span class="o">-eq</span> <span class="nv">$containerCheck</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-AzStorageContainer</span> <span class="n">-name</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span><span class="p">).</span><span class="py">Context</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Storage container created: </span><span class="nv">$containerName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-output</span> <span class="s2">&#34;Container already exists&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet3.jpg" alt="code-snippet-3"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet3.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="5-upload-certificates-to-container">5. Upload certificates to container</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## upload certs to container</span>
</span></span><span class="line"><span class="cl"><span class="nv">$certs</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$exportFolder</span> <span class="n">-Filter</span> <span class="p">*.</span><span class="n">cer</span>
</span></span><span class="line"><span class="cl"><span class="nv">$storageContext</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span><span class="p">).</span><span class="py">Context</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="nv">$certs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$localFilePath</span> <span class="p">=</span> <span class="nv">$item</span><span class="p">.</span><span class="py">FullName</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$azureFileName</span> <span class="p">=</span> <span class="nv">$localFilePath</span><span class="p">.</span><span class="py">Split</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">)[</span><span class="nv">$localFilePath</span><span class="p">.</span><span class="py">Split</span><span class="p">(</span><span class="s1">&#39;\&#39;</span><span class="p">).</span><span class="n">count</span><span class="p">-</span><span class="mf">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Get-AzStorageAccount</span> <span class="n">-Name</span> <span class="nv">$storageAccountName</span> <span class="n">-ResourceGroupName</span> <span class="nv">$storageRgName</span> <span class="p">|</span> <span class="nb">Get-AzStorageContainer</span> <span class="n">-Name</span> <span class="nv">$containerName</span> <span class="p">|</span> <span class="nb">Set-AzStorageBlobContent</span> <span class="o">-File</span> <span class="nv">$localFilePath</span> <span class="n">-Blob</span> <span class="nv">$azureFileName</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg" alt="code-snippet-5"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<h2 id="6-create-the-sas-tokens">6. Create the SAS Tokens</h2>
<p><strong>Notes</strong><br>
<em><strong>$containerName</strong></em> will need to be updated</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create SAS token</span>
</span></span><span class="line"><span class="cl"><span class="nv">$containerName</span> <span class="p">=</span> <span class="s2">&#34;ldaps&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$blobs</span> <span class="p">=</span> <span class="nb">Get-AzStorageBlob</span> <span class="n">-Container</span> <span class="nv">$containerName</span> <span class="n">-Context</span> <span class="nv">$storageContext</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="py">name</span> <span class="o">-match</span> <span class="s2">&#34;.cer&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$blob</span> <span class="k">in</span> <span class="nv">$blobs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$StartTime</span> <span class="p">=</span> <span class="nb">Get-Date</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$EndTime</span> <span class="p">=</span> <span class="nv">$startTime</span><span class="p">.</span><span class="py">AddHours</span><span class="p">(</span><span class="mf">24.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$sasToken</span> <span class="p">=</span> <span class="nb">New-AzStorageBlobSASToken</span> <span class="n">-Container</span> <span class="nv">$containerName</span> <span class="n">-Blob</span> <span class="nv">$blob</span><span class="p">.</span><span class="py">name</span> <span class="n">-Permission</span> <span class="n">rwd</span> <span class="n">-StartTime</span> <span class="nv">$StartTime</span> <span class="n">-ExpiryTime</span> <span class="nv">$EndTime</span> <span class="n">-Context</span> <span class="nv">$storageContext</span> <span class="n">-FullUri</span>
</span></span><span class="line"><span class="cl">    <span class="c">#$sasToken</span>
</span></span><span class="line"><span class="cl">    <span class="nb">write-host</span> <span class="s2">&#34;SASToken created: </span><span class="nv">$sasToken</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg" alt="code-snippet-5"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet5.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>SASToken created: <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a><br>
SASToken created: <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a></p>
<h2 id="execute-the-avs-run-command">Execute the AVS Run Command</h2>
<p>These steps, for now, are run manually from the <a href="https://portal.azure.com">Azure Portal</a>. This will be found &ldquo;Azure VMware Solution&rdquo; and under Operations, <strong>Run command</strong>. Then select <strong>&ldquo;New-LDAPSIdentitySource&rdquo;</strong></p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet7.jpg" alt="code-snippet-7"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet7.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Populate the information as needed.<br>
<strong>Note: the SSLCertificateSasUrl is a single string consisting of the SASTokens separated with a “,”. For example, <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc001.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a>, <a href="https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;%5BRemoved%5D">https://avsgwcsa14a2c2da.blob.core.windows.net/ldaps-blog-post/avs-gwc-dc002.cer?sv=2021-10-04&amp;st=2023-01-12T13%3A46%3A45Z&amp;se=2023-01-13T13%3A46%3A45Z&amp;sr=b&amp;sp=rwd&amp;[Removed]</a> and pasted as a single long string.</strong>
The other values would need to be updated as per your environment.<br>
<strong>Note: With the BaseDNGroups and BaseDNUsers, watch the values used as these should be under the same tree, in this example, “OU=Corp,DC=avsemea,DC=com”</strong></p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet8.jpg" alt="code-snippet-8"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet8.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Once all information is entered, Run the command.</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet9.jpg" alt="code-snippet-9"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet9.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>You can check the status of the <strong>Run command</strong> within the portal, under Operations, <strong>Run command</strong>, then select <strong>Run execution status</strong> and then select the correct job.</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet10.jpg" alt="code-snippet-10"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet10.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>You can check the status of the job now and you are waiting for all the tasks to be completed and show that your selected group was added to <strong>CloudAdmins</strong></p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet11.jpg" alt="code-snippet-11"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet11.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>You can also check the output and ensure that the correct name was added.</p>


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet12.jpg" alt="code-snippet-12"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet12.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>You can logon with LDAP based credentials.


<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet13.jpg" alt="code-snippet-13"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet13.jpg" itemprop="contentUrl"></a>
  </figure>
</div>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2023/avs-ldaps-configure/snippet14.jpg" alt="code-snippet-14"/>
    </div>
    <a href="/images/blogImages/2023/avs-ldaps-configure/snippet14.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</p>


        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f&amp;text=How%20to%20configure%20LDAPS%20with%20AVS&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f&amp;title=How%20to%20configure%20LDAPS%20with%20AVS" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f&amp;title=How%20to%20configure%20LDAPS%20with%20AVS" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f&amp;title=How%20to%20configure%20LDAPS%20with%20AVS" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=http%3a%2f%2flocalhost%3a1313%2fpost%2f2023%2favs-ldaps-configure%2f&amp;description=How%20to%20configure%20LDAPS%20with%20AVS" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="http://localhost:1313/post/2022/using-arg-tolock-resources/" data-toggle="tooltip" data-placement="top" title="Using Azure Resource Graph and Tags to lock items in Azure">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="http://localhost:1313/post/2023/avs-ldaps-configure-part4/" data-toggle="tooltip" data-placement="top" title="Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 4">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/fskelly" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/fletcherkelly" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Fletcher Kelly
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="http://localhost:1313/">Fletcher&#39;s Cloud Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.139.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="http://localhost:1313/js/main.js"></script>
<script src="http://localhost:1313/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="http://localhost:1313/js/load-photoswipe.js"></script>










    
  </body>
</html>


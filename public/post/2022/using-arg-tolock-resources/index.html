

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Using Azure Resource Graph and Tags to lock items in Azure - </title>

  <meta name="description" content="What are we doing?
We are going to use Azure Resource Graph to find items with a specific tag, in this case {&ldquo;toBeLocked&rdquo;=&ldquo;Yes&rdquo;} and then place a resource lock on them.
Constraints / limitations

Use Azure Resource Graph to perform the search. Very fast and gives you a new way to interface with Azure Resources.
As part of this post, I am giving samples below to create items, you could use these for testing. Please test and make sure with production environment.
You are using an account that can create locks and potentially remove if needed during the testing.

Lets build this
Steps

Create sample items
Build Azure Resource Graph Queries
Getting items from the query programmatically
Adding locks
Result

Create sample items to lock
## create resource group
$rgName = &#34;toberesourcelocked&#34;
$rgLocation = &#34;northeurope&#34;
$rg = new-azresourcegroup -name $rgname -location $rgLocation

## create items
$guid = New-Guid
$saName = &#34;sa&#34;
$saSuffix = $guid.ToString().Split(&#34;-&#34;)[0]&#43;$guid.ToString().Split(&#34;-&#34;)[1]
$saName = (($saName.replace(&#34;-&#34;,&#34;&#34;))&#43;$saSuffix)
New-AzStorageAccount -ResourceGroupName $rgName -Name $saName -Location $rgLocation -AccountType Standard_LRS

## create tag(s)
$tags = @{&#34;toBeLocked&#34;=&#34;Yes&#34;}

## get items in Resource Group and tag them
$items = Get-AzResource -ResourceGroupName $rgName
foreach ($item in $items)
{
    Update-AzTag -ResourceId $item.ResourceId -Tag $tags -Operation Replace
} 
## update resource group with tag(s)
Update-AzTag -ResourceId $rg.ResourceId -Tag $tags -Operation Replace
Build Azure Resource Graph Queries
Including Resource Groups
resourcecontainers
| where type == &#34;microsoft.resources/subscriptions/resourcegroups&#34;
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
| project  name,type,location,subscriptionId,tags
| union (resources 
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
| project name,type,location,subscriptionId,tags,id)
Excluding Resource Groups
Resources
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
Resource Groups Only
ResourceContainers
| where type =~ &#39;microsoft.resources/subscriptions/resourcegroups&#39;
| where tags[&#39;toBeLocked&#39;] =~ &#39;Yes&#39;
Getting items from the query programmatically
We now have the required queries and you can pick whichever one above suits your needs, I am going to be using Including Resource Groups. Now we need a way to act against these resources. I am personally quite a fan of PowerShell so I will provide this sample. You can use this as a base for my example below. When running the query in PowerShell, I find splatting is easiest for Azure Resource Graph queries">
  <meta name="author" content="Fletcher Kelly"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Fletcher\u0027s Cloud Blog",
    
    "url": "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/post\/2022\/using-arg-tolock-resources\/",
          "name": "Using azure resource graph and tags to lock items in azure"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Fletcher Kelly"
  },
  "headline": "Using Azure Resource Graph and Tags to lock items in Azure",
  "description" : "What are we doing? We are going to use Azure Resource Graph to find items with a specific tag, in this case {\u0026ldquo;toBeLocked\u0026rdquo;=\u0026ldquo;Yes\u0026rdquo;} and then place a resource lock on them.\nConstraints \/ limitations Use Azure Resource Graph to perform the search. Very fast and gives you a new way to interface with Azure Resources. As part of this post, I am giving samples below to create items, you could use these for testing. Please test and make sure with production environment. You are using an account that can create locks and potentially remove if needed during the testing. Lets build this Steps Create sample items Build Azure Resource Graph Queries Getting items from the query programmatically Adding locks Result Create sample items to lock ## create resource group $rgName = \u0026#34;toberesourcelocked\u0026#34; $rgLocation = \u0026#34;northeurope\u0026#34; $rg = new-azresourcegroup -name $rgname -location $rgLocation ## create items $guid = New-Guid $saName = \u0026#34;sa\u0026#34; $saSuffix = $guid.ToString().Split(\u0026#34;-\u0026#34;)[0]\u002b$guid.ToString().Split(\u0026#34;-\u0026#34;)[1] $saName = (($saName.replace(\u0026#34;-\u0026#34;,\u0026#34;\u0026#34;))\u002b$saSuffix) New-AzStorageAccount -ResourceGroupName $rgName -Name $saName -Location $rgLocation -AccountType Standard_LRS ## create tag(s) $tags = @{\u0026#34;toBeLocked\u0026#34;=\u0026#34;Yes\u0026#34;} ## get items in Resource Group and tag them $items = Get-AzResource -ResourceGroupName $rgName foreach ($item in $items) { Update-AzTag -ResourceId $item.ResourceId -Tag $tags -Operation Replace } ## update resource group with tag(s) Update-AzTag -ResourceId $rg.ResourceId -Tag $tags -Operation Replace Build Azure Resource Graph Queries Including Resource Groups resourcecontainers | where type == \u0026#34;microsoft.resources\/subscriptions\/resourcegroups\u0026#34; | mv-expand bagexpansion=array tags | where isnotempty(tags) | where tags[0] =~ \u0026#39;toBeLocked\u0026#39; and tags[1] =~ \u0026#39;Yes\u0026#39; | project name,type,location,subscriptionId,tags | union (resources | mv-expand bagexpansion=array tags | where isnotempty(tags) | where tags[0] =~ \u0026#39;toBeLocked\u0026#39; and tags[1] =~ \u0026#39;Yes\u0026#39; | project name,type,location,subscriptionId,tags,id) Excluding Resource Groups Resources | mv-expand bagexpansion=array tags | where isnotempty(tags) | where tags[0] =~ \u0026#39;toBeLocked\u0026#39; and tags[1] =~ \u0026#39;Yes\u0026#39; Resource Groups Only ResourceContainers | where type =~ \u0026#39;microsoft.resources\/subscriptions\/resourcegroups\u0026#39; | where tags[\u0026#39;toBeLocked\u0026#39;] =~ \u0026#39;Yes\u0026#39; Getting items from the query programmatically We now have the required queries and you can pick whichever one above suits your needs, I am going to be using Including Resource Groups. Now we need a way to act against these resources. I am personally quite a fan of PowerShell so I will provide this sample. You can use this as a base for my example below. When running the query in PowerShell, I find splatting is easiest for Azure Resource Graph queries\n",
  "inLanguage" : "en",
  "wordCount":  623 ,
  "datePublished" : "2022-10-03T13:59:06\u002b01:00",
  "dateModified" : "2022-10-03T13:59:06\u002b01:00",
  "image" : "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/",
  "keywords" : [ "PowerShell, Azure Resource Graph" ],
  "mainEntityOfPage" : "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/post\/2022\/using-arg-tolock-resources\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/swacloudblogflkelly.z1.web.core.windows.net\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="Using Azure Resource Graph and Tags to lock items in Azure" />
<meta property="og:description" content="What are we doing?
We are going to use Azure Resource Graph to find items with a specific tag, in this case {&ldquo;toBeLocked&rdquo;=&ldquo;Yes&rdquo;} and then place a resource lock on them.
Constraints / limitations

Use Azure Resource Graph to perform the search. Very fast and gives you a new way to interface with Azure Resources.
As part of this post, I am giving samples below to create items, you could use these for testing. Please test and make sure with production environment.
You are using an account that can create locks and potentially remove if needed during the testing.

Lets build this
Steps

Create sample items
Build Azure Resource Graph Queries
Getting items from the query programmatically
Adding locks
Result

Create sample items to lock
## create resource group
$rgName = &#34;toberesourcelocked&#34;
$rgLocation = &#34;northeurope&#34;
$rg = new-azresourcegroup -name $rgname -location $rgLocation

## create items
$guid = New-Guid
$saName = &#34;sa&#34;
$saSuffix = $guid.ToString().Split(&#34;-&#34;)[0]&#43;$guid.ToString().Split(&#34;-&#34;)[1]
$saName = (($saName.replace(&#34;-&#34;,&#34;&#34;))&#43;$saSuffix)
New-AzStorageAccount -ResourceGroupName $rgName -Name $saName -Location $rgLocation -AccountType Standard_LRS

## create tag(s)
$tags = @{&#34;toBeLocked&#34;=&#34;Yes&#34;}

## get items in Resource Group and tag them
$items = Get-AzResource -ResourceGroupName $rgName
foreach ($item in $items)
{
    Update-AzTag -ResourceId $item.ResourceId -Tag $tags -Operation Replace
} 
## update resource group with tag(s)
Update-AzTag -ResourceId $rg.ResourceId -Tag $tags -Operation Replace
Build Azure Resource Graph Queries
Including Resource Groups
resourcecontainers
| where type == &#34;microsoft.resources/subscriptions/resourcegroups&#34;
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
| project  name,type,location,subscriptionId,tags
| union (resources 
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
| project name,type,location,subscriptionId,tags,id)
Excluding Resource Groups
Resources
| mv-expand bagexpansion=array tags
| where isnotempty(tags)
| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
Resource Groups Only
ResourceContainers
| where type =~ &#39;microsoft.resources/subscriptions/resourcegroups&#39;
| where tags[&#39;toBeLocked&#39;] =~ &#39;Yes&#39;
Getting items from the query programmatically
We now have the required queries and you can pick whichever one above suits your needs, I am going to be using Including Resource Groups. Now we need a way to act against these resources. I am personally quite a fan of PowerShell so I will provide this sample. You can use this as a base for my example below. When running the query in PowerShell, I find splatting is easiest for Azure Resource Graph queries">
<meta property="og:url" content="https://swacloudblogflkelly.z1.web.core.windows.net/post/2022/using-arg-tolock-resources/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Fletcher&#39;s Cloud Blog" />

  <meta name="twitter:title" content="Using Azure Resource Graph and Tags to lock items in Azure" />
  <meta name="twitter:description" content="What are we doing?
We are going to use Azure Resource Graph to find items with a specific tag, in this case {&ldquo;toBeLocked&rdquo;=&ldquo;Yes&rdquo;} and then place a resource lock on them. …">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="generator" content="Hugo 0.139.2">
  <link rel="alternate" href="https://swacloudblogflkelly.z1.web.core.windows.net/index.xml" type="application/rss+xml" title="Fletcher&#39;s Cloud Blog"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css" integrity="sha384-h/hnnw1Bi4nbpD6kE7nYfCXzovi622sY5WBxww8ARKwpdLj5kUWjRuyiXaD1U2JT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://swacloudblogflkelly.z1.web.core.windows.net/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://swacloudblogflkelly.z1.web.core.windows.net/css/highlight.min.css" /><link rel="stylesheet" href="https://swacloudblogflkelly.z1.web.core.windows.net/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://swacloudblogflkelly.z1.web.core.windows.net/">Fletcher&#39;s Cloud Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About Blog" href="/page/about/">About Blog</a>
            </li>
          
        
          
            <li>
              <a title="About Fletcher Kelly" href="/page/fletcherkelly/">About Fletcher Kelly</a>
            </li>
          
        
          
            <li>
              <a title="About Robin Heringa" href="/page/robinheringa/">About Robin Heringa</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Using Azure Resource Graph and Tags to lock items in Azure</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 3, 2022
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;623&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Fletcher Kelly
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h2 id="what-are-we-doing">What are we doing?</h2>
<p>We are going to use Azure Resource Graph to find items with a specific tag, in this case <em>{&ldquo;toBeLocked&rdquo;=&ldquo;Yes&rdquo;}</em> and then place a resource lock on them.</p>
<h2 id="constraints--limitations">Constraints / limitations</h2>
<ol>
<li>Use Azure Resource Graph to perform the search. Very fast and gives you a new way to interface with Azure Resources.</li>
<li>As part of this post, I am giving samples below to create items, you could use these for testing. Please test and make sure with production environment.</li>
<li>You are using an account that can create locks and potentially remove if needed during the testing.</li>
</ol>
<h2 id="lets-build-this">Lets build this</h2>
<h3 id="steps">Steps</h3>
<ol>
<li>Create sample items</li>
<li>Build Azure Resource Graph Queries</li>
<li>Getting items from the query programmatically</li>
<li>Adding locks</li>
<li>Result</li>
</ol>
<h3 id="create-sample-items-to-lock">Create sample items to lock</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">## create resource group</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rgName</span> <span class="p">=</span> <span class="s2">&#34;toberesourcelocked&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rgLocation</span> <span class="p">=</span> <span class="s2">&#34;northeurope&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$rg</span> <span class="p">=</span> <span class="nb">new-azresourcegroup</span> <span class="n">-name</span> <span class="nv">$rgname</span> <span class="n">-location</span> <span class="nv">$rgLocation</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## create items</span>
</span></span><span class="line"><span class="cl"><span class="nv">$guid</span> <span class="p">=</span> <span class="nb">New-Guid</span>
</span></span><span class="line"><span class="cl"><span class="nv">$saName</span> <span class="p">=</span> <span class="s2">&#34;sa&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$saSuffix</span> <span class="p">=</span> <span class="nv">$guid</span><span class="p">.</span><span class="py">ToString</span><span class="p">().</span><span class="py">Split</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]+</span><span class="nv">$guid</span><span class="p">.</span><span class="py">ToString</span><span class="p">().</span><span class="py">Split</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">$saName</span> <span class="p">=</span> <span class="p">((</span><span class="nv">$saName</span><span class="p">.</span><span class="py">replace</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span><span class="s2">&#34;&#34;</span><span class="p">))+</span><span class="nv">$saSuffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">New-AzStorageAccount</span> <span class="n">-ResourceGroupName</span> <span class="nv">$rgName</span> <span class="n">-Name</span> <span class="nv">$saName</span> <span class="n">-Location</span> <span class="nv">$rgLocation</span> <span class="n">-AccountType</span> <span class="n">Standard_LRS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## create tag(s)</span>
</span></span><span class="line"><span class="cl"><span class="nv">$tags</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span><span class="s2">&#34;toBeLocked&#34;</span><span class="p">=</span><span class="s2">&#34;Yes&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">## get items in Resource Group and tag them</span>
</span></span><span class="line"><span class="cl"><span class="nv">$items</span> <span class="p">=</span> <span class="nb">Get-AzResource</span> <span class="n">-ResourceGroupName</span> <span class="nv">$rgName</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$item</span> <span class="k">in</span> <span class="nv">$items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Update-AzTag</span> <span class="n">-ResourceId</span> <span class="nv">$item</span><span class="p">.</span><span class="py">ResourceId</span> <span class="n">-Tag</span> <span class="nv">$tags</span> <span class="n">-Operation</span> <span class="n">Replace</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c">## update resource group with tag(s)</span>
</span></span><span class="line"><span class="cl"><span class="nb">Update-AzTag</span> <span class="n">-ResourceId</span> <span class="nv">$rg</span><span class="p">.</span><span class="py">ResourceId</span> <span class="n">-Tag</span> <span class="nv">$tags</span> <span class="n">-Operation</span> <span class="n">Replace</span>
</span></span></code></pre></div><h3 id="build-azure-resource-graph-queries">Build Azure Resource Graph Queries</h3>
<h4 id="including-resource-groups">Including Resource Groups</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">resourcecontainers
</span></span><span class="line"><span class="cl">| where type == &#34;microsoft.resources/subscriptions/resourcegroups&#34;
</span></span><span class="line"><span class="cl">| mv-expand bagexpansion=array tags
</span></span><span class="line"><span class="cl">| where isnotempty(tags)
</span></span><span class="line"><span class="cl">| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
</span></span><span class="line"><span class="cl">| project  name,type,location,subscriptionId,tags
</span></span><span class="line"><span class="cl">| union (resources 
</span></span><span class="line"><span class="cl">| mv-expand bagexpansion=array tags
</span></span><span class="line"><span class="cl">| where isnotempty(tags)
</span></span><span class="line"><span class="cl">| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
</span></span><span class="line"><span class="cl">| project name,type,location,subscriptionId,tags,id)
</span></span></code></pre></div><h4 id="excluding-resource-groups">Excluding Resource Groups</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Resources
</span></span><span class="line"><span class="cl">| mv-expand bagexpansion=array tags
</span></span><span class="line"><span class="cl">| where isnotempty(tags)
</span></span><span class="line"><span class="cl">| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
</span></span></code></pre></div><h4 id="resource-groups-only">Resource Groups Only</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ResourceContainers
</span></span><span class="line"><span class="cl">| where type =~ &#39;microsoft.resources/subscriptions/resourcegroups&#39;
</span></span><span class="line"><span class="cl">| where tags[&#39;toBeLocked&#39;] =~ &#39;Yes&#39;
</span></span></code></pre></div><h3 id="getting-items-from-the-query-programmatically">Getting items from the query programmatically</h3>
<p>We now have the required queries and you can pick whichever one above suits your needs, I am going to be using <a href="#including-resource-groups">Including Resource Groups</a>. Now we need a way to act against these resources. I am personally quite a fan of <a href="https://learn.microsoft.com/en-us/powershell/">PowerShell</a> so I will provide this sample. You can use <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/first-query-powershell#add-the-resource-graph-module">this</a> as a base for my example below. When running the query in <a href="https://learn.microsoft.com/en-us/powershell/">PowerShell</a>, I find <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_splatting?view=powershell-7.2">splatting</a> is easiest for <a href="https://learn.microsoft.com/en-us/azure/governance/resource-graph/">Azure Resource Graph</a> queries</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Install the Resource Graph module from PowerShell Gallery</span>
</span></span><span class="line"><span class="cl"><span class="nb">Install-Module</span> <span class="n">-Name</span> <span class="n">Az</span><span class="p">.</span><span class="py">ResourceGraph</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Get a list of commands for the imported Az.ResourceGraph module</span>
</span></span><span class="line"><span class="cl"><span class="nb">Get-Command</span> <span class="n">-Module</span> <span class="s1">&#39;Az.ResourceGraph&#39;</span> <span class="n">-CommandType</span> <span class="s1">&#39;Cmdlet&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># Run Azure Resource Graph query</span>
</span></span><span class="line"><span class="cl"><span class="nv">$query</span> <span class="p">=</span> <span class="sh">@&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">resourcecontainers
</span></span></span><span class="line"><span class="cl"><span class="sh">| where type == &#34;microsoft.resources/subscriptions/resourcegroups&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">| mv-expand bagexpansion=array tags
</span></span></span><span class="line"><span class="cl"><span class="sh">| where isnotempty(tags)
</span></span></span><span class="line"><span class="cl"><span class="sh">| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
</span></span></span><span class="line"><span class="cl"><span class="sh">| project  name,type,location,subscriptionId,tags
</span></span></span><span class="line"><span class="cl"><span class="sh">| union (resources 
</span></span></span><span class="line"><span class="cl"><span class="sh">| mv-expand bagexpansion=array tags
</span></span></span><span class="line"><span class="cl"><span class="sh">| where isnotempty(tags)
</span></span></span><span class="line"><span class="cl"><span class="sh">| where tags[0] =~ &#39;toBeLocked&#39; and tags[1] =~ &#39;Yes&#39;
</span></span></span><span class="line"><span class="cl"><span class="sh">| project name,type,location,subscriptionId,tags,id)
</span></span></span><span class="line"><span class="cl"><span class="sh">&#34;@</span>
</span></span><span class="line"><span class="cl"><span class="nv">$queryItems</span> <span class="p">=</span> <span class="nb">Search-AzGraph</span> <span class="n">-Query</span> <span class="nv">$query</span>
</span></span></code></pre></div><h3 id="adding-locks">Adding locks</h3>
<p>So now we have the items that have been tagged, now we can go through the process of adding a <a href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/lock-resources?tabs=json">Resource Lock</a>. The <a href="https://learn.microsoft.com/en-us/powershell/module/az.resources/new-azresourcelock?view=azps-8.3.0">New-AzResourceLock</a> will be used for this task.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nv">$lockLevel</span> <span class="p">=</span> <span class="s2">&#34;CanNotDelete&#34;</span> <span class="c">## can be changed to &#34;ReadOnly&#34; as well</span>
</span></span><span class="line"><span class="cl"><span class="nv">$lockNotes</span> <span class="p">=</span> <span class="s2">&#34;Lock for demo blog purposes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$lockName</span> <span class="p">=</span> <span class="s2">&#34;Demo Lock&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$queryItem</span> <span class="k">in</span> <span class="nv">$queryItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$name</span> <span class="p">=</span> <span class="nv">$queryItem</span><span class="p">.</span><span class="py">Name</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$type</span> <span class="p">=</span> <span class="nv">$queryItem</span><span class="p">.</span><span class="nb">Type
</span></span></span><span class="line"><span class="cl"><span class="nb"></span>    <span class="nb">write-host</span> <span class="s2">&#34;Locking </span><span class="nv">$name</span><span class="s2"> (</span><span class="nv">$type</span><span class="s2">)&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">-eq</span> <span class="s2">&#34;microsoft.resources/subscriptions/resourcegroups&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-AzResourceLock</span> <span class="n">-LockName</span> <span class="nv">$lockName</span> <span class="n">-LockLevel</span> <span class="nv">$lockLevel</span> <span class="n">-LockNotes</span> <span class="nv">$lockNotes</span> <span class="n">-ResourceGroupName</span> <span class="nv">$name</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resourceGroupName</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$queryItem</span><span class="p">.</span><span class="n">id</span><span class="p">).</span><span class="py">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)[</span><span class="mf">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">New-AzResourceLock</span> <span class="n">-LockLevel</span> <span class="nv">$lockLevel</span> <span class="n">-LockNotes</span> <span class="nv">$lockNotes</span> <span class="n">-LockName</span> <span class="nv">$lockName</span> <span class="n">-ResourceName</span> <span class="nv">$queryItem</span><span class="p">.</span><span class="py">Name</span> <span class="n">-ResourceType</span> <span class="nv">$queryItem</span><span class="p">.</span><span class="nb">Type </span><span class="n">-ResourceGroupName</span> <span class="nv">$resourceGroupName</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="results">Results</h3>
<p>Results can be seen below. Our Locks are now in place. Since my account is an <strong>owner</strong>, I can delete the lock(s), <em>non-owner(s)</em> would <strong>NOT</strong> be able to delete locks.</p>

<link rel="stylesheet" href="https://swacloudblogflkelly.z1.web.core.windows.net/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/images/blogImages/2022/using-arg-tolock-resources/resulting-locks.jpg" alt="resulting locks in azure"/>
    </div>
    <a href="/images/blogImages/2022/using-arg-tolock-resources/resulting-locks.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>This code and concept can be easily updated or modified to meet different your specific requirements.</p>


        
          <div class="blog-tags">
            
              
              <a href="https://swacloudblogflkelly.z1.web.core.windows.net/tags/powershell/">PowerShell</a>&nbsp;
            
              
              <a href="https://swacloudblogflkelly.z1.web.core.windows.net/tags/azure-resource-graph/">Azure Resource Graph</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f&amp;text=Using%20Azure%20Resource%20Graph%20and%20Tags%20to%20lock%20items%20in%20Azure&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f&amp;title=Using%20Azure%20Resource%20Graph%20and%20Tags%20to%20lock%20items%20in%20Azure" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f&amp;title=Using%20Azure%20Resource%20Graph%20and%20Tags%20to%20lock%20items%20in%20Azure" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f&amp;title=Using%20Azure%20Resource%20Graph%20and%20Tags%20to%20lock%20items%20in%20Azure" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fswacloudblogflkelly.z1.web.core.windows.net%2fpost%2f2022%2fusing-arg-tolock-resources%2f&amp;description=Using%20Azure%20Resource%20Graph%20and%20Tags%20to%20lock%20items%20in%20Azure" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/2023/starting-wth-rest-calls-with-powershell/">Starting Wth API Rest Calls With Powershell</a></li>
                
                    <li><a href="/post/2022/check-powershell-type/">Check Powershell Console Type</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://swacloudblogflkelly.z1.web.core.windows.net/post/2022/arc-ssh-windows-linux/" data-toggle="tooltip" data-placement="top" title="Using Arc to SSH into Linux and Windows">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://swacloudblogflkelly.z1.web.core.windows.net/post/2023/avs-ldaps-configure-part4/" data-toggle="tooltip" data-placement="top" title="Azure VMware Solution: A comprehensive guide to LDAPS identity integration - Part 4">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="https://github.com/fskelly" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/fletcherkelly" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Fletcher Kelly
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://swacloudblogflkelly.z1.web.core.windows.net/">Fletcher&#39;s Cloud Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.139.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://swacloudblogflkelly.z1.web.core.windows.net/js/main.js"></script>
<script src="https://swacloudblogflkelly.z1.web.core.windows.net/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://swacloudblogflkelly.z1.web.core.windows.net/js/load-photoswipe.js"></script>










    
  </body>
</html>

